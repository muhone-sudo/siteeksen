version: '3.8'

services:
  # PostgreSQL - Ana veritabanı
  postgres:
    image: postgres:16-alpine
    container_name: siteeksen-postgres
    environment:
      POSTGRES_DB: siteeksen
      POSTGRES_USER: siteeksen
      POSTGRES_PASSWORD: ${DB_PASSWORD:-siteeksen_dev_123}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/migrations:/docker-entrypoint-initdb.d
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U siteeksen" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis - Cache ve Session
  redis:
    image: redis:7-alpine
    container_name: siteeksen-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

  # MongoDB - Doküman veritabanı (IoT sensör verileri için)
  mongodb:
    image: mongo:7
    container_name: siteeksen-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: siteeksen
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:-siteeksen_dev_123}
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db

  # Kafka - Event Bus
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: siteeksen-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
    volumes:
      - zookeeper_data:/var/lib/zookeeper/data

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: siteeksen-kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    volumes:
      - kafka_data:/var/lib/kafka/data

  # Identity Service
  identity-service:
    build:
      context: ./backend
      dockerfile: services/identity/Dockerfile
    container_name: siteeksen-identity
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: siteeksen
      DB_PASSWORD: ${DB_PASSWORD:-siteeksen_dev_123}
      DB_NAME: siteeksen
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      REDIS_URL: redis://redis:6379/0
      PORT: 8081
    ports:
      - "8081:8081"
    depends_on:
      postgres:
        condition: service_healthy

  # Finance Service
  finance-service:
    build:
      context: ./backend
      dockerfile: services/finance/Dockerfile
    container_name: siteeksen-finance
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: siteeksen
      DB_PASSWORD: ${DB_PASSWORD:-siteeksen_dev_123}
      DB_NAME: siteeksen
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      IYZICO_API_KEY: ${IYZICO_API_KEY:-sandbox-key}
      IYZICO_SECRET_KEY: ${IYZICO_SECRET_KEY:-sandbox-secret}
      IYZICO_BASE_URL: https://sandbox-api.iyzipay.com
      PORT: 8082
    ports:
      - "8082:8082"
    depends_on:
      postgres:
        condition: service_healthy

  # Community Service
  community-service:
    build:
      context: ./backend
      dockerfile: services/community/Dockerfile
    container_name: siteeksen-community
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: siteeksen
      DB_PASSWORD: ${DB_PASSWORD:-siteeksen_dev_123}
      DB_NAME: siteeksen
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      PORT: 8083
    ports:
      - "8083:8083"
    depends_on:
      postgres:
        condition: service_healthy

  # IoT Service
  iot-service:
    build:
      context: ./backend
      dockerfile: services/iot/Dockerfile
    container_name: siteeksen-iot
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: siteeksen
      DB_PASSWORD: ${DB_PASSWORD:-siteeksen_dev_123}
      DB_NAME: siteeksen
      MONGO_URL: mongodb://siteeksen:${MONGO_PASSWORD:-siteeksen_dev_123}@mongodb:27017
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      PORT: 8084
    ports:
      - "8084:8084"
    depends_on:
      postgres:
        condition: service_healthy
      mongodb:
        condition: service_started

  # Notification Service
  notification-service:
    build:
      context: ./backend
      dockerfile: services/notification/Dockerfile
    container_name: siteeksen-notification
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: siteeksen
      DB_PASSWORD: ${DB_PASSWORD:-siteeksen_dev_123}
      DB_NAME: siteeksen
      REDIS_URL: redis://redis:6379/1
      KAFKA_BROKERS: kafka:29092
      FIREBASE_PROJECT_ID: ${FIREBASE_PROJECT_ID:-siteeksen-dev}
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      PORT: 8085
    ports:
      - "8085:8085"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      kafka:
        condition: service_started
    volumes:
      - ./firebase-credentials.json:/app/firebase-credentials.json:ro

  # Admin Panel (Next.js)
  admin-panel:
    build:
      context: ./admin
      dockerfile: Dockerfile
    container_name: siteeksen-admin
    environment:
      NEXT_PUBLIC_API_URL: http://kong:8000/api/v1
      NEXTAUTH_URL: http://localhost:3001
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:-your-nextauth-secret-change-in-production}
    ports:
      - "3001:3001"
    depends_on:
      - kong

  # Kong API Gateway
  kong:
    image: kong:3.5
    container_name: siteeksen-kong
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/kong.yml
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
    ports:
      - "8000:8000"
      - "8001:8001"
    volumes:
      - ./kong/kong.yml:/kong/kong.yml:ro
    depends_on:
      - identity-service
      - finance-service
      - community-service
      - iot-service
      - notification-service

volumes:
  postgres_data:
  redis_data:
  mongodb_data:
  zookeeper_data:
  kafka_data:
